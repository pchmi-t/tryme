<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <meta name="description" content="">
  <meta name="author" content="TryMe">

  <title>TryMe</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href='http://fonts.googleapis.com/css?family=Oswald:400,300,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="../css/main.css">
  <link rel="stylesheet" type="text/css" href="../css/nav.css">
  <link rel="stylesheet" type="text/css" href="../css/make_test.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <style type="text/css"></style>
</head>
<body>
<div class="container" id="page">
<!-- ======================== NAVBAR ======================== -->
  <div class="navWrapper navbar-fixed-top">
    <div class="upper">
      <img src="../imgs/upper_Nav.png">
    </div>
    <nav class="navbar navbar-inverse ">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        </button>
        <a class="navbar-brand" href="Home.html">TryMe</a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a class="active" href="Home.html">Начало</a></li>
          <li><a href="tests.html">Тестове</a></li>
          <li><a href="scoreboard.html">Класации</a></li>
          <li><a id="profilebtn" href="profile.html">Профил</a></li>
        </ul>
        <form class="navbar-form navbar-right">
          <a id="loginbtn" class="btn btn-success" href="sign-in.html">Вписване</a>
          <a id="regbtn" class="btn btn-success" href="sign-up.html">Регистриране</a>
          <a id="logoutbtn" class="btn btn-success" href="Home.html">Излез</a>
        </form>
      </div>
    </nav>
  </div>
<!-- ======================== NAVBAR ======================== -->

<!-- ======================== CONTENT ======================== -->
  <div id="content" class="content">
    <div class="row infobar">
        <div class="col-md-3 clock">
            <div class="infobar-sidebar">
                <div class="infobar-tile ">
                    <br/>
                    <div class="panel-heading"><h3>Остават:</h3></div>
                    <span id="clock"></span>
                    <div class="panel-heading"><h3>Прогрес:</h3></div>
                    <div class = "progress">
                        <div class = "progress-bar" role="progressbar" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
         <br/>
<div id="errormsg" class="alert alert-danger" hidden=true>
         <strong>Грешка!</strong> Моля изберете отговор.</div>
        <div class="question jumbotron"></div>
        <div class="btn-group pull-right btn-navigator" role="group">
            <button id="prev" type="button" class="btn btn-secondary" disabled>
                <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span> Предишен
            </button>
            <button id="next" type="button" class="btn btn-secondary">Следващ <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span></button>
            <button id="submit" type="button" class="btn btn-warning"><a type="button" style="color: black;" href="completeTest.html"><span class="glyphicon glyphicon-check" aria-hidden="true"></span>   Предай теста</a></button>
        </div>
    </div><!-- /.container -->
  </div>
<!-- ======================== CONTENT ======================== -->
</div>
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="../js/navbar.js"></script>
    <script src="../js/main.js"></script>
    <script src="../jquery.countdown/jquery.countdown.js"></script>
    <script>
    var endTest = new Date(new Date().getTime() + 30 * 60000);
    
    $('#clock').countdown(endTest, function(event) {
        $(this).html('<h1>' + event.strftime('%M:%S') + '</h1>');
    });
    
    totalScore = 0;
    var currentQuestion = 0;
    var totalScore = 0;
    $.ajaxSetup({async: false});
    $.get('/tryme/api/v1.0/tests/', function(data){
    	 questions = data[0].questions;
    });
    
    var qHtml = buildQuestion(questions[currentQuestion]);
    $(".question").html(qHtml);
    
    $('#next').on('click', getNext);
    $('#prev').on('click', getPrev);
    $('#submit').on('click', submit);
    
    function getNext() {
    	var q = questions[currentQuestion];
    	var selected = $('input[name=ans]:checked', '#question');
    	if (selected.length > 0) {
    	 checkIfCorrect(selected.val(), q) 	    
    	} else {
    		$("#errormsg").show();
    		$("#errormsg").slideToggle(3000);
    		return;
    	}
    
        currentQuestion++;
        if (currentQuestion >= questions.length) {
            currentQuestion = questions.length - 1;
            return;
        }
        
        var qHtml = buildQuestion(questions[currentQuestion]);
        $(".question").html(qHtml);
        $("#prev").removeAttr('disabled');
        
        updateProgress();
        
        if (currentQuestion >= questions.length - 1) {
            $('#next').attr('disabled','disabled');
            
        }
    }
    
    function submit() {
    	var q = questions[currentQuestion];
    	var selected = $('input[name=ans]:checked', '#question');
    	if (selected.length > 0) {
    	 checkIfCorrect(selected.val(), q)
    	 sessionStorage.setItem("totalScore", totalScore);
    	 sessionStorage.setItem("result",  Math.floor((totalScore / (questions.length * 10))*100) );
    	 sessionStorage.setItem("timeRemaining", $('#clock h1').text());
    	 sessionStorage.setItem("maxScore", questions.length * 10);
    	 
    	 $.ajaxSetup({async:false});
    	 $.ajax({
    		  type: "POST",
    		  url: '/tryme/api/v1.0/scores',
    		  data: JSON.stringify({ "username": 'eminkaa', "score" : totalScore }),
    		  contentType : 'application/json',
    		});
    	 
    	 window.location.href= "completeTest.html";
    	 
    	} else {
    		$("#errormsg").show();
    		$("#errormsg").slideToggle(3000);
    		return;
    	}
    }
    
    function checkIfCorrect(selectedVal, q) {
   	    isCorrect = false;
   	    q.answers.forEach(function(item) { if (item.content === selectedVal && !isCorrect) {
   	    	isCorrect = item.correct;
   	    } });
   	    
   	    if (isCorrect) {
   	    	totalScore += 10;
   	    }
    }
    
    function updateProgress() {
        var percentage = Math.floor((currentQuestion/questions.length)*100);
        $('.progress-bar').css('width', percentage+'%');
        $('.progress-bar').html(percentage+'%');
    }
    
    function getPrev() {
        currentQuestion--;
        if (currentQuestion < 0 ) {
            currentQuestion = 0;
            return;
        }
        
        var qHtml = buildQuestion(questions[currentQuestion]);
        $(".question").html(qHtml);
        $("#next").removeAttr('disabled');
        updateProgress();
        if (currentQuestion == 0 ) {
            $('#prev').attr('disabled','disabled');
        }
    }
    
    function buildQuestion(question) {
        var qHtml = '<h2>' + question.text + '</h2>';
        qHtml += ' <br/><form id="question">';
        question.answers.forEach(function(answer) {
                qHtml += '<input type="radio" name="ans" value="' + answer.content + '">   ' + answer.content +'<br>';
            }
        );
        qHtml += '<br/></form>';
        return qHtml;
    }
    
    </script>
    
    <script src="auth.js"></script>
  </body>
</html>
